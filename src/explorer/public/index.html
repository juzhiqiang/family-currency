<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Currency - 区块链浏览器</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .hash-text {
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- 导航栏 -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <i class="fas fa-coins text-2xl"></i>
                    <h1 class="text-2xl font-bold">Family Currency</h1>
                    <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm">区块链浏览器</span>
                </div>
                <div class="flex items-center space-x-6">
                    <div class="flex items-center space-x-2">
                        <div id="status-indicator" class="w-3 h-3 bg-green-400 rounded-full pulse"></div>
                        <span id="status-text" class="text-sm">连接中...</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="container mx-auto px-6 py-8">
        <!-- 统计概览 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">当前区块高度</p>
                        <p id="current-height" class="text-2xl font-bold text-blue-600">-</p>
                    </div>
                    <i class="fas fa-cubes text-3xl text-blue-500"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">总交易数</p>
                        <p id="total-transactions" class="text-2xl font-bold text-green-600">-</p>
                    </div>
                    <i class="fas fa-exchange-alt text-3xl text-green-500"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">代币总供应量</p>
                        <p id="total-supply" class="text-2xl font-bold text-purple-600">-</p>
                    </div>
                    <i class="fas fa-coins text-3xl text-purple-500"></i>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 card-hover">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">挖矿难度</p>
                        <p id="difficulty" class="text-2xl font-bold text-orange-600">-</p>
                    </div>
                    <i class="fas fa-hammer text-3xl text-orange-500"></i>
                </div>
            </div>
        </div>

        <!-- 搜索栏 -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <div class="flex items-center space-x-4">
                <div class="flex-1">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="搜索区块高度、哈希值或地址..." 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                <button 
                    id="search-btn" 
                    class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors"
                >
                    <i class="fas fa-search"></i> 搜索
                </button>
            </div>
            <div id="search-results" class="mt-4 hidden"></div>
        </div>

        <!-- 钱包管理区域 -->
        <div class="bg-white rounded-lg shadow-md mb-8">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-wallet mr-2 text-blue-500"></i>钱包管理
                    </h2>
                    <div class="flex space-x-3">
                        <button id="create-wallet-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            <i class="fas fa-plus mr-2"></i>创建钱包
                        </button>
                        <button id="import-wallet-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            <i class="fas fa-download mr-2"></i>导入钱包
                        </button>
                        <button id="transfer-btn" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-colors" disabled>
                            <i class="fas fa-paper-plane mr-2"></i>转账
                        </button>
                    </div>
                </div>
                
                <!-- 当前钱包信息 -->
                <div id="current-wallet" class="hidden">
                    <div class="bg-gradient-to-r from-blue-50 to-purple-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-semibold text-gray-700">当前钱包</h3>
                            <span id="wallet-balance" class="text-lg font-bold text-blue-600">0.00 FC</span>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div>
                                <span class="text-gray-600">地址：</span>
                                <span id="wallet-address" class="hash-text font-mono text-gray-800 break-all"></span>
                                <button id="copy-address" class="ml-2 text-blue-500 hover:text-blue-700">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <div>
                                <span class="text-gray-600">名称：</span>
                                <span id="wallet-name" class="text-gray-800"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 钱包列表 -->
                <div id="wallet-list" class="space-y-3"></div>
                
                <!-- 无钱包提示 -->
                <div id="no-wallet" class="text-center py-8 text-gray-500">
                    <i class="fas fa-wallet text-4xl mb-4 text-gray-300"></i>
                    <p class="text-lg">还没有钱包</p>
                    <p class="text-sm">创建或导入一个钱包开始使用</p>
                </div>
            </div>
        </div>
        
        <!-- 转账模态框 -->
        <div id="transfer-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">代币转账</h3>
                            <button id="close-transfer-modal" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <form id="transfer-form">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    发送方钱包
                                </label>
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <p class="font-medium text-gray-800" id="sender-wallet-name"></p>
                                    <p class="text-sm text-gray-600 hash-text break-all" id="sender-wallet-address"></p>
                                    <p class="text-sm font-semibold text-blue-600" id="sender-wallet-balance"></p>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label for="recipient-address" class="block text-sm font-medium text-gray-700 mb-2">
                                    接收方地址
                                </label>
                                <input type="text" id="recipient-address" placeholder="输入接收方钱包地址"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 font-mono text-sm">
                            </div>
                            <div class="mb-4">
                                <label for="transfer-amount" class="block text-sm font-medium text-gray-700 mb-2">
                                    转账金额 (FC)
                                </label>
                                <input type="number" id="transfer-amount" placeholder="0.00" step="0.01" min="0.01"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <p class="text-xs text-gray-500 mt-1">最小转账金额: 0.01 FC</p>
                            </div>
                            <div class="mb-6">
                                <label for="transfer-note" class="block text-sm font-medium text-gray-700 mb-2">
                                    备注 (可选)
                                </label>
                                <input type="text" id="transfer-note" placeholder="转账备注"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div class="flex space-x-3">
                                <button type="button" id="cancel-transfer" class="flex-1 px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    取消
                                </button>
                                <button type="submit" class="flex-1 px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600">
                                    <i class="fas fa-paper-plane mr-2"></i>发送
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 创建钱包模态框 -->
        <div id="create-wallet-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">创建新钱包</h3>
                            <button id="close-create-modal" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <form id="create-wallet-form">
                            <div class="mb-4">
                                <label for="wallet-name-input" class="block text-sm font-medium text-gray-700 mb-2">
                                    钱包名称
                                </label>
                                <input type="text" id="wallet-name-input" placeholder="输入钱包名称"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="flex space-x-3">
                                <button type="button" id="cancel-create" class="flex-1 px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    取消
                                </button>
                                <button type="submit" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                    创建钱包
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 导入钱包模态框 -->
        <div id="import-wallet-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold">导入钱包</h3>
                            <button id="close-import-modal" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <form id="import-wallet-form">
                            <div class="mb-4">
                                <label for="import-wallet-name" class="block text-sm font-medium text-gray-700 mb-2">
                                    钱包名称
                                </label>
                                <input type="text" id="import-wallet-name" placeholder="输入钱包名称"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div class="mb-4">
                                <label for="private-key-input" class="block text-sm font-medium text-gray-700 mb-2">
                                    私钥
                                </label>
                                <textarea id="private-key-input" placeholder="输入私钥" rows="3"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
                            </div>
                            <div class="flex space-x-3">
                                <button type="button" id="cancel-import" class="flex-1 px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">
                                    取消
                                </button>
                                <button type="submit" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">
                                    导入钱包
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- 标签页 -->
        <div class="bg-white rounded-lg shadow-md">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8 px-6">
                    <button class="tab-btn py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-medium" data-tab="blocks">
                        <i class="fas fa-cube mr-2"></i>最新区块
                    </button>
                    <button class="tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700" data-tab="transactions">
                        <i class="fas fa-exchange-alt mr-2"></i>最新交易
                    </button>
                </nav>
            </div>
            
            <!-- 区块列表 -->
            <div id="blocks-tab" class="tab-content p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">最新区块</h3>
                    <button id="refresh-blocks" class="text-blue-500 hover:text-blue-700">
                        <i class="fas fa-sync-alt"></i> 刷新
                    </button>
                </div>
                <div id="blocks-list" class="space-y-4">
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
                        <p class="text-gray-500">正在加载区块数据...</p>
                    </div>
                </div>
            </div>
            
            <!-- 交易列表 -->
            <div id="transactions-tab" class="tab-content p-6 hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">最新交易</h3>
                    <button id="refresh-transactions" class="text-blue-500 hover:text-blue-700">
                        <i class="fas fa-sync-alt"></i> 刷新
                    </button>
                </div>
                <div id="transactions-list" class="space-y-4">
                    <div class="text-center py-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto mb-4"></div>
                        <p class="text-gray-500">正在加载交易数据...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class BlockchainExplorer {
            constructor() {
                this.currentTab = 'blocks';
                this.wallets = JSON.parse(localStorage.getItem('wallets') || '[]');
                this.currentWalletIndex = parseInt(localStorage.getItem('currentWalletIndex') || '-1');
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadInitialData();
                this.setupWalletManagement();
                this.loadWallets();
                
                // 每5秒刷新一次数据
                setInterval(() => {
                    this.loadStats();
                    this.updateWalletBalances();
                    if (this.currentTab === 'blocks') {
                        this.loadBlocks();
                    }
                }, 5000);
            }

            setupEventListeners() {
                // 标签页切换
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tab = btn.dataset.tab;
                        this.switchTab(tab);
                    });
                });

                // 搜索功能
                const searchBtn = document.getElementById('search-btn');
                const searchInput = document.getElementById('search-input');
                
                searchBtn.addEventListener('click', () => this.performSearch());
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.performSearch();
                });

                // 刷新按钮
                document.getElementById('refresh-blocks').addEventListener('click', () => this.loadBlocks());
                document.getElementById('refresh-transactions').addEventListener('click', () => this.loadTransactions());
            }

            switchTab(tab) {
                // 更新按钮样式
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    if (btn.dataset.tab === tab) {
                        btn.className = 'tab-btn py-4 px-2 border-b-2 border-blue-500 text-blue-600 font-medium';
                    } else {
                        btn.className = 'tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                    }
                });

                // 显示对应内容
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                document.getElementById(`${tab}-tab`).classList.remove('hidden');

                this.currentTab = tab;

                // 加载数据
                if (tab === 'blocks') {
                    this.loadBlocks();
                } else if (tab === 'transactions') {
                    this.loadTransactions();
                }
            }

            async loadInitialData() {
                this.updateStatus('已连接', 'green');
                await this.loadStats();
                await this.loadBlocks();
            }

            updateStatus(text, color) {
                const indicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                
                indicator.className = `w-3 h-3 rounded-full ${
                    color === 'green' ? 'bg-green-400 pulse' : 
                    color === 'red' ? 'bg-red-400' : 'bg-yellow-400'
                }`;
                statusText.textContent = text;
            }

            async loadStats() {
                try {
                    const response = await fetch('/api/explorer/overview');
                    const data = await response.json();
                    
                    if (data.success) {
                        document.getElementById('current-height').textContent = data.overview.height;
                        document.getElementById('total-transactions').textContent = data.overview.totalTransactions.toLocaleString();
                        document.getElementById('total-supply').textContent = data.overview.totalSupply.toFixed(2) + ' FC';
                        document.getElementById('difficulty').textContent = data.overview.difficulty;
                    }
                } catch (error) {
                    console.error('加载统计数据失败:', error);
                    this.updateStatus('连接错误', 'red');
                }
            }

            async loadBlocks() {
                try {
                    const response = await fetch('/api/explorer/blocks?limit=10');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.renderBlocks(data.blocks);
                    }
                } catch (error) {
                    console.error('加载区块数据失败:', error);
                }
            }

            renderBlocks(blocks) {
                const container = document.getElementById('blocks-list');
                
                if (blocks.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">暂无区块数据</p>';
                    return;
                }

                container.innerHTML = blocks.map(block => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-4">
                                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                                    #${block.height}
                                </span>
                                <span class="text-gray-600">${new Date(block.timestamp).toLocaleString()}</span>
                            </div>
                            <div class="flex items-center space-x-4 text-sm text-gray-500">
                                <span><i class="fas fa-exchange-alt mr-1"></i>${block.transactionCount} 交易</span>
                                <span><i class="fas fa-weight-hanging mr-1"></i>${(block.size / 1024).toFixed(2)} KB</span>
                            </div>
                        </div>
                        <div class="text-sm">
                            <p class="text-gray-600 mb-1">哈希: <span class="hash-text text-blue-600">${block.hash}</span></p>
                            <p class="text-gray-600">矿工: <span class="hash-text">${block.miner || '未知'}</span></p>
                        </div>
                    </div>
                `).join('');
            }

            async loadTransactions() {
                try {
                    const response = await fetch('/api/explorer/transactions?limit=20');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.renderTransactions(data.transactions);
                    }
                } catch (error) {
                    console.error('加载交易数据失败:', error);
                }
            }

            renderTransactions(transactions) {
                const container = document.getElementById('transactions-list');
                
                if (transactions.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">暂无交易数据</p>';
                    return;
                }

                container.innerHTML = transactions.map(tx => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-4">
                                <span class="bg-${this.getTypeColor(tx.type)}-100 text-${this.getTypeColor(tx.type)}-800 px-3 py-1 rounded-full text-sm font-medium">
                                    ${this.getTypeLabel(tx.type)}
                                </span>
                                <span class="text-gray-600">${new Date(tx.timestamp).toLocaleString()}</span>
                            </div>
                            <div class="text-lg font-semibold text-green-600">
                                ${tx.amount} FC
                            </div>
                        </div>
                        <div class="text-sm space-y-1">
                            <p class="text-gray-600">
                                从: <span class="hash-text">${tx.fromAddress || '系统'}</span>
                            </p>
                            <p class="text-gray-600">
                                到: <span class="hash-text">${tx.toAddress || '销毁'}</span>
                            </p>
                            <p class="text-gray-600">
                                交易ID: <span class="hash-text text-blue-600">${tx.txId}</span>
                            </p>
                        </div>
                    </div>
                `).join('');
            }

            getTypeColor(type) {
                switch (type) {
                    case 'mint': return 'green';
                    case 'transfer': return 'blue';
                    case 'burn': return 'red';
                    default: return 'gray';
                }
            }

            getTypeLabel(type) {
                switch (type) {
                    case 'mint': return '铸造';
                    case 'transfer': return '转账';
                    case 'burn': return '销毁';
                    default: return '未知';
                }
            }

            async performSearch() {
                const query = document.getElementById('search-input').value.trim();
                if (!query) return;

                try {
                    const response = await fetch(`/api/explorer/search/${encodeURIComponent(query)}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.renderSearchResults(data.results, data.query);
                    }
                } catch (error) {
                    console.error('搜索失败:', error);
                }
            }

            renderSearchResults(results, query) {
                const container = document.getElementById('search-results');
                
                if (results.blocks.length === 0 && results.transactions.length === 0 && results.addresses.length === 0) {
                    container.innerHTML = `<p class="text-gray-500">未找到关于 "${query}" 的结果</p>`;
                    container.classList.remove('hidden');
                    return;
                }

                let html = '';
                
                if (results.blocks.length > 0) {
                    html += '<h4 class="font-semibold mb-2">区块</h4>';
                    html += results.blocks.map(block => `
                        <div class="border border-gray-200 rounded p-3 mb-2 cursor-pointer hover:bg-gray-50">
                            <p class="font-medium">区块 #${block.height}</p>
                            <p class="text-sm text-gray-600 hash-text">${block.hash}</p>
                        </div>
                    `).join('');
                }
                
                if (results.transactions.length > 0) {
                    html += '<h4 class="font-semibold mb-2 mt-4">交易</h4>';
                    html += results.transactions.map(tx => `
                        <div class="border border-gray-200 rounded p-3 mb-2 cursor-pointer hover:bg-gray-50">
                            <p class="font-medium">${tx.amount} FC - ${this.getTypeLabel(tx.type)}</p>
                            <p class="text-sm text-gray-600 hash-text">${tx.txId}</p>
                        </div>
                    `).join('');
                }
                
                if (results.addresses.length > 0) {
                    html += '<h4 class="font-semibold mb-2 mt-4">地址</h4>';
                    html += results.addresses.map(addr => `
                        <div class="border border-gray-200 rounded p-3 mb-2">
                            <p class="font-medium">余额: ${addr.balance} FC</p>
                            <p class="text-sm text-gray-600 hash-text">${addr.address}</p>
                        </div>
                    `).join('');
                }

                container.innerHTML = html;
                container.classList.remove('hidden');
            }

            // ============ 钱包管理功能 ============

            setupWalletManagement() {
                // 创建钱包按钮
                document.getElementById('create-wallet-btn').addEventListener('click', () => {
                    document.getElementById('create-wallet-modal').classList.remove('hidden');
                });

                // 导入钱包按钮
                document.getElementById('import-wallet-btn').addEventListener('click', () => {
                    document.getElementById('import-wallet-modal').classList.remove('hidden');
                });

                // 转账按钮
                document.getElementById('transfer-btn').addEventListener('click', () => {
                    this.openTransferModal();
                });

                // 模态框关闭按钮
                document.getElementById('close-create-modal').addEventListener('click', () => {
                    this.closeCreateModal();
                });
                document.getElementById('close-import-modal').addEventListener('click', () => {
                    this.closeImportModal();
                });
                document.getElementById('close-transfer-modal').addEventListener('click', () => {
                    this.closeTransferModal();
                });
                document.getElementById('cancel-create').addEventListener('click', () => {
                    this.closeCreateModal();
                });
                document.getElementById('cancel-import').addEventListener('click', () => {
                    this.closeImportModal();
                });
                document.getElementById('cancel-transfer').addEventListener('click', () => {
                    this.closeTransferModal();
                });

                // 创建钱包表单
                document.getElementById('create-wallet-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.createWallet();
                });

                // 导入钱包表单
                document.getElementById('import-wallet-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.importWallet();
                });

                // 转账表单
                document.getElementById('transfer-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.performTransfer();
                });

                // 复制地址按钮
                document.getElementById('copy-address').addEventListener('click', () => {
                    this.copyToClipboard(document.getElementById('wallet-address').textContent);
                });

                // 点击模态框背景关闭
                document.getElementById('create-wallet-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'create-wallet-modal') {
                        this.closeCreateModal();
                    }
                });
                document.getElementById('import-wallet-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'import-wallet-modal') {
                        this.closeImportModal();
                    }
                });
                document.getElementById('transfer-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'transfer-modal') {
                        this.closeTransferModal();
                    }
                });
            }

            async createWallet() {
                const name = document.getElementById('wallet-name-input').value.trim();
                if (!name) {
                    alert('请输入钱包名称');
                    return;
                }

                try {
                    const response = await fetch('/api/wallet/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    const data = await response.json();
                    if (data.success) {
                        const wallet = {
                            id: Date.now(),
                            name: name,
                            address: data.wallet.address,
                            publicKey: data.wallet.publicKey,
                            privateKey: data.wallet.privateKey,
                            balance: 0,
                            createdAt: new Date().toISOString()
                        };

                        this.wallets.push(wallet);
                        this.currentWalletIndex = this.wallets.length - 1;
                        this.saveWallets();
                        this.loadWallets();
                        this.closeCreateModal();
                        
                        alert('钱包创建成功！');
                    } else {
                        alert('创建钱包失败：' + data.message);
                    }
                } catch (error) {
                    console.error('创建钱包失败:', error);
                    alert('创建钱包失败，请稍后重试');
                }
            }

            async importWallet() {
                const name = document.getElementById('import-wallet-name').value.trim();
                const privateKey = document.getElementById('private-key-input').value.trim();
                
                if (!name || !privateKey) {
                    alert('请填写完整信息');
                    return;
                }

                try {
                    
                    // 使用 /api/users/:address 接口获取用户信息
                    const response = await fetch(`/api/wallet/import`,{
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ privateKey })
                    });
                    const data = await response.json();

                    if (data.success) {
                        // 获取钱包余额
                        const balanceResponse = await fetch(`/api/wallet/balance/${data.wallet.address}`);
                        const balanceData = await balanceResponse.json();
                        
                        const wallet = {
                            id: Date.now(),
                            name: name,
                            address: data.wallet.address,
                            publicKey: data.wallet.publicKey,
                            privateKey: data.wallet.privateKey,
                            balance: balanceData.success ? balanceData.balance : 0,
                            createdAt: new Date().toISOString()
                        };

                        this.wallets.push(wallet);
                        this.currentWalletIndex = this.wallets.length - 1;
                        this.saveWallets();
                        this.loadWallets();
                        this.closeImportModal();
                        
                        alert('钱包导入成功！');
                    } else {
                        alert('导入钱包失败：' + data.message);
                    }
                } catch (error) {
                    console.error('导入钱包失败:', error);
                    alert('导入钱包失败，请检查私钥格式');
                }
            }

            loadWallets() {
                const currentWalletDiv = document.getElementById('current-wallet');
                const walletListDiv = document.getElementById('wallet-list');
                const noWalletDiv = document.getElementById('no-wallet');

                if (this.wallets.length === 0) {
                    currentWalletDiv.classList.add('hidden');
                    walletListDiv.innerHTML = '';
                    noWalletDiv.classList.remove('hidden');
                    return;
                }

                noWalletDiv.classList.add('hidden');
                // 禁用转账按钮
                document.getElementById('transfer-btn').disabled = true;

                // 显示当前钱包
                if (this.currentWalletIndex >= 0 && this.currentWalletIndex < this.wallets.length) {
                    const currentWallet = this.wallets[this.currentWalletIndex];
                    document.getElementById('wallet-name').textContent = currentWallet.name;
                    document.getElementById('wallet-address').textContent = currentWallet.address;
                    document.getElementById('wallet-balance').textContent = `${currentWallet.balance.toFixed(2)} FC`;
                    currentWalletDiv.classList.remove('hidden');
                    
                    // 启用转账按钮
                    document.getElementById('transfer-btn').disabled = false;
                } else {
                    // 禁用转账按钮
                    document.getElementById('transfer-btn').disabled = true;
                }

                // 显示钱包列表
                walletListDiv.innerHTML = this.wallets.map((wallet, index) => `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer ${index === this.currentWalletIndex ? 'bg-blue-50 border-blue-300' : ''}"
                         onclick="explorer.switchWallet(${index})">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium text-gray-800">${wallet.name}</h4>
                                <p class="text-sm text-gray-600 hash-text">${wallet.address}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-blue-600">${wallet.balance.toFixed(2)} FC</p>
                                <p class="text-sm text-gray-500">${index === this.currentWalletIndex ? '当前' : '切换'}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            switchWallet(index) {
                if (index >= 0 && index < this.wallets.length) {
                    this.currentWalletIndex = index;
                    this.saveWallets();
                    this.loadWallets();
                }
            }

            async updateWalletBalances() {
                if (this.wallets.length === 0) return;

                for (let i = 0; i < this.wallets.length; i++) {
                    try {
                        const response = await fetch(`/api/wallet/balance/${this.wallets[i].address}`);
                        const data = await response.json();
                        if (data.success) {
                            this.wallets[i].balance = data.balance;
                        }
                    } catch (error) {
                        console.error('更新钱包余额失败:', error);
                    }
                }
                
                this.saveWallets();
                this.loadWallets();
            }

            saveWallets() {
                localStorage.setItem('wallets', JSON.stringify(this.wallets));
                localStorage.setItem('currentWalletIndex', this.currentWalletIndex.toString());
            }

            closeCreateModal() {
                document.getElementById('create-wallet-modal').classList.add('hidden');
                document.getElementById('wallet-name-input').value = '';
            }

            closeImportModal() {
                document.getElementById('import-wallet-modal').classList.add('hidden');
                document.getElementById('import-wallet-name').value = '';
                document.getElementById('private-key-input').value = '';
            }

            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    alert('地址已复制到剪贴板');
                }).catch(err => {
                    console.error('复制失败:', err);
                    // 回退方案
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('地址已复制到剪贴板');
                });
            }

            openTransferModal() {
                if (this.currentWalletIndex < 0 || this.currentWalletIndex >= this.wallets.length) {
                    alert('请先选择一个钱包');
                    return;
                }

                const currentWallet = this.wallets[this.currentWalletIndex];
                document.getElementById('sender-wallet-name').textContent = currentWallet.name;
                document.getElementById('sender-wallet-address').textContent = currentWallet.address;
                document.getElementById('sender-wallet-balance').textContent = `余额: ${currentWallet.balance.toFixed(2)} FC`;
                
                document.getElementById('transfer-modal').classList.remove('hidden');
            }

            closeTransferModal() {
                document.getElementById('transfer-modal').classList.add('hidden');
                document.getElementById('recipient-address').value = '';
                document.getElementById('transfer-amount').value = '';
                document.getElementById('transfer-note').value = '';
            }

            async performTransfer() {
                const recipientAddress = document.getElementById('recipient-address').value.trim();
                const amount = parseFloat(document.getElementById('transfer-amount').value);
                const note = document.getElementById('transfer-note').value.trim();

                if (!recipientAddress || !amount) {
                    alert('请填写完整的转账信息');
                    return;
                }

                if (amount <= 0) {
                    alert('转账金额必须大于0');
                    return;
                }

                const currentWallet = this.wallets[this.currentWalletIndex];
                if (amount > currentWallet.balance) {
                    alert('余额不足');
                    return;
                }

                if (recipientAddress === currentWallet.address) {
                    alert('不能转账给自己');
                    return;
                }

                try {
                    const response = await fetch('/api/transaction/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fromAddress: currentWallet.address,
                            toAddress: recipientAddress,
                            amount: amount,
                            privateKey: currentWallet.privateKey,
                            note: note || undefined
                        })
                    });

                    const data = await response.json();
                    console.log('转账响应:', data);
                    if (data.success) {
                        alert(`转账成功！交易ID: ${data.transaction.txId}`);
                        this.closeTransferModal();
                        // 更新钱包余额
                        await this.updateWalletBalances();
                        // 刷新交易列表
                        if (this.currentTab === 'transactions') {
                            this.loadTransactions();
                        }
                    } else {
                        alert('转账失败：' + data.message);
                    }
                } catch (error) {
                    console.error('转账失败:', error);
                    alert('转账失败，请稍后重试');
                }
            }
        }

        // 初始化应用
        const explorer = new BlockchainExplorer();
    </script>
</body>
</html>